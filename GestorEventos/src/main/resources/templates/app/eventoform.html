<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Evento Form</title>
	<!-- Bootstrap-5.2.3 -->
	<link rel="stylesheet" th:href="@{/vendor/bootstrap-icons/bootstrap-icons.css}">
	<!-- Bootstrap-Icons -->
	<link rel="stylesheet" th:href="@{/vendor/bootstrap-5.2.3/css/bootstrap.min.css}">
	<!-- General CSS -->
	<link th:href="@{/css/app.css}" rel="stylesheet">
</head>

<body>
	<header>
		<h1>
			<strong>Event</strong><strong>App</strong>
		</h1>
		<nav>
			<div class="sidenav">
				<a class="closebtn">&times;</a> <a
					th:href="@{/admin/usuarios/{idUsuario}/eventos (idUsuario=${usuarioDTO.id})}">Volver</a>
			</div>
			<div>
				<img th:src="@{/media/img/menu.png}" alt="menu">
			</div>
		</nav>
	</header>

	<main>

		<div class="container col-lg-8 p-4 rounded shadow bg-body mt-3 text-start">

			<form th:action="@{/admin/usuarios/{idUsuario}/eventos/save (idUsuario=${usuarioDTO.id})}" method="POST"
				th:object="${eventoDTO}">

				<div class="mt-1 text-center">
					<h2 class="h2 rounded" th:text="${add} ? 'Nuevo evento' : 'Actualizar evento'"></h2>
				</div>

				<div class="mt-3" th:if="${errorMessage}" th:utext="${errorMessage}"></div>

				<div class="mt-3 row" th:if="!${add}">
					<label for="id" class="form-label col">Id</label> <input type="text" name="id"
						class="form-control-plaintext col" id="id" th:field="*{id}" readonly />
				</div>

				<div class="row mt-3">
					<div class="col-4">
						<label for="anfitrion" class="form-label">Anfitrion</label> <input readonly th:type="text"
							name="anfitrion" class="form-control" id="anfitrion"
							th:placeholder="${usuarioDTO.nombreUsuario}" th:field="*{usuarioDTO.nombreUsuario}"
							th:maxlength="40" />
					</div>
					<div class="col-8">
						<label for="nombre" class="form-label">Nombre</label> <input th:type="text" name="nombre"
							class="form-control" id="nombre" th:field="*{nombre}" th:maxlength="40" />
					</div>
				</div>
				<div class="row mt-3">
					<div class="col">
						<label for="tipo" class="form-label">Tipo Evento</label> <select id="selectTipo" name="tipo"
							th:field="*{tipo}" class="form-select">
							<option selected hidden="true" value="0">Seleccione un tipo</option>
							<option value="Boda">Boda</option>
							<option value="Congreso">Congreso</option>
							<option value="Ponencia">Ponencia</option>
							<option value="Comunion">Comunión</option>
							<option value="Otros">Otros</option>
						</select>
					</div>
				</div>

				<div class="row mt-3">
					<div class="col">
						<label for="fechaInicio" class="form-label">Fecha inicio</label> <input th:type="date"
							name="fechaInicio" class="form-control" id="fechaInicio" th:field="*{fechaInicio}"
							th:maxlength="100" />
					</div>
					<div class="col">
						<label for="fechaFin" class="form-label">Fecha Fin</label> <input th:type="date" name="fechaFin"
							class="form-control" id="fechaFin" th:field="*{fechaFin}" th:maxlength="100" />
					</div>
				</div>

				<div class="row mt-3">
					<div class="col">
						<label for="ubicacion" class="form-label">Ubicacion</label> <select id="selectUbicacion"
							name="ubicacion" th:field="*{ubicacionDTO.id}" class="form-select">
							<option selected value="0">Selecciona una
								ubicación</option>
							<option th:each="ubicacionDTO : ${listaUbicacionesDTO}" th:value="${ubicacionDTO.id}"
								th:text="${ubicacionDTO.nombre}">
							</option>
						</select>
					</div>
				</div>


				<div id="divCatering" class="row mt-3" style="display: none;">
					<div class="col">
						<label for="catering" class="form-label">Catering</label> <select id="selectCatering"
							name="catering" th:field="*{cateringDTO.id}" class="form-select">
							<option selected value="0">Selecciona un
								catering</option>


						</select>
					</div>
				</div>

				<!--Precio/Foto Catering-->
				<div id="fotoPrecioCatering" class="row mt-3" style="display: none;">

					<div id="divFotoCatering">
						<img id="fotoCatering">
					</div>
					<div id="divPrecioCatering">
						<label for="precioCatering">Precio Catering</label>
						<input readonly type="number" name="precioCatering" id="precioCatering">
					</div>

				</div>

				<div id="divDecorado" class="row mt-3" style="display: none;">
					<div class="col">
						<label for="decorado" class="form-label">Decorado</label> <select id="selectDecorado"
							name="decorado" th:field="*{decoradoDTO.id}" class="form-select">
							<option selected value="0">Selecciona un
								decorado</option>
						</select>
					</div>
				</div>
				<!--Precio/Foto Decorado-->
				<div id="fotoPrecioDecorado" class="row mt-3" style="display: none;">

					<div id="divFotoDecorado">
						<img id="fotoDecorado">
					</div>
					<div id="divPrecioDecorado">
						<label class="form-label col" for="precioDecorado">Precio Decorado</label>
						<input class="form-control col" readonly type="number" name="precioDecorado"
							id="precioDecorado">
					</div>
				</div>

				<div id="divOcio" class="row mt-3" style="display: none;">
					<div class="col">
						<label for="ocio" class="form-label">Ocio</label> <select id="selectOcio" name="ocio"
							th:field="*{ocioDTO.id}" class="form-select">
							<option selected value="0">Selecciona un
								ocio</option>


						</select>
					</div>
				</div>

				<!--Precio/Foto Ocio-->
				<div id="fotoPrecioOcio" class="row mt-3" style="display: none;">

					<div id="divFotoOcio">
						<img id="fotoOcio">
					</div>
					<div id="divPrecioOcio">
						<label class="form-label col" for="precioOcio">Precio Ocio</label>
						<input class="form-control col" readonly type="number" name="precioOcio" id="precioOcio">
					</div>

				</div>

				<!--Precio Evento-->
				<div id="precioEvento" class="row mt-3">
					<label for="precioEvento" class="form-label col">Precio Final:</label> <input type="number"
						name="precioEvento" class="form-control col" id="precioEvento" th:field="*{precio}" />
				</div>

				<div class="mt-4">
					<input type="submit" th:value="${add} ? 'Añadir' : 'Actualizar'"
						class="btn btn-outline-success w-100" />
				</div>

			</form>

		</div>

	</main>

	<script th:inline="javascript">
		var selectUbicacion = document.getElementById('selectUbicacion');
		selectUbicacion.addEventListener('change', listados);


		//Función para listar por provincia
		function listados() {
			//Variables
			var selectCatering = document.getElementById('selectCatering');
			var selectDecorado = document.getElementById('selectDecorado');
			var selectOcio = document.getElementById('selectOcio');
			var ubicacionList = /*[[${listaUbicacionesDTO}]]*/[];
			var cateringList = /*[[${listaCateringsDTO}]]*/[];
			var decoradoList = /*[[${listaDecoradosDTO}]]*/[];
			var ocioList = /*[[${listaOciosDTO}]]*/[];
			var ubi = null;
			var idUbi = selectUbicacion.value;

			//Divs contenedores de los select
			var divCatering = document.getElementById('divCatering');
			var divDecorado = document.getElementById('divDecorado');
			var divOcio = document.getElementById('divOcio');
			//Divs de la imagen y el precio
			var divFPCatering = document.getElementById('fotoPrecioCatering');
			var divFPDecorado = document.getElementById('fotoPrecioDecorado');
			var divFPOcio = document.getElementById('fotoPrecioOcio');
			//Quitamos los precios y las imagenes porque se ha cambiado la ubicación
			divCatering.style.display = "none";
			divDecorado.style.display = "none";
			divOcio.style.display = "none";
			divFPCatering.style.display = "none";
			divFPDecorado.style.display = "none";
			divFPOcio.style.display = "none";

			//Buscamos la ubicacion
			for (var i = 0; i < ubicacionList.length; i++) {
				if (ubicacionList[i].id == idUbi) {
					ubi = ubicacionList[i];
				}
			};

			if (ubi) {
				//Creamos la lista para los caterings filtrados y los añdimos y vaciamos
				var filteredCaterings = [];
				vaciarSelect(selectCatering);
				for (var i = 0; i < cateringList.length; i++) {
					if (cateringList[i].empresaDTO.direccionDTO.provincia == ubi.direccionDTO.provincia) {
						filteredCaterings.push(cateringList[i]);
					}
				};


				for (var i = 0; i < filteredCaterings.length; i++) {
					var option = document.createElement('option');
					option.value = filteredCaterings[i].id;
					option.text = filteredCaterings[i].menu;
					selectCatering.appendChild(option);
				}
				//Mostramos el div que contiene el select del Catering y le añadimos el eventListener al select
				divCatering.style.display = "block";
				selectCatering.addEventListener('change', function () {
					if (this.value !== "0") {
						//Recogemos el objeto Decorado

						var c = buscarObjetoPorId(this.value, cateringList);
						console.log(c);
						var i = document.getElementById('fotoCatering');
						var p = document.getElementById('precioCatering');
						if (c) {
							//Recogemos el elemento con la imagen y el input 
							p.placeholder = c.precio;
							i.src = c.foto;
						} else {
							p.placeholder = "Error";
							i.alt = "Error";
						}
						divFPCatering.style.display = "block";
					} else {
						divFPCatering.style.display = "none";
					}
				});

				//Decorado Filtrado
				var filteredDecorados = [];
				vaciarSelect(selectDecorado);
				for (var i = 0; i < decoradoList.length; i++) {
					console.log(decoradoList[i].empresaDTO.direccionDTO.provincia);
					if (decoradoList[i].empresaDTO.direccionDTO.provincia == ubi.direccionDTO.provincia) {
						filteredDecorados.push(decoradoList[i]);
					}
				};

				for (var i = 0; i < filteredDecorados.length; i++) {
					var option = document.createElement('option');
					option.value = filteredDecorados[i].id;
					option.text = filteredDecorados[i].nombre;
					selectDecorado.appendChild(option);
				}
				//Mostramos el div que contiene el select del Decorado
				divDecorado.style.display = "block";
				selectDecorado.addEventListener('change', function () {
					if (this.value !== "0") {
						//Recogemos el objeto Decorado
						console.log(this.value);
						var d = buscarObjetoPorId(this.value, decoradoList);
						console.log(d);
						var i = document.getElementById('fotoDecorado');
						var p = document.getElementById('precioDecorado');
						if (d) {
							//Recogemos el elemento con la imagen y el input 
							p.placeholder = d.precio;
							i.src = d.foto;
						} else {
							p.placeholder = "Error";
							i.alt = "Error";
						}
						divFPDecorado.style.display = "block";
					} else {
						divFPDecorado.style.display = "none";
					}
				});

				//Ocio Filtrado
				var filteredOcios = [];
				vaciarSelect(selectOcio);
				for (var i = 0; i < ocioList.length; i++) {
					console.log(ocioList[i].empresaDTO.direccionDTO.provincia);
					if (ocioList[i].empresaDTO.direccionDTO.provincia == ubi.direccionDTO.provincia) {
						filteredOcios.push(ocioList[i]);
					}
				};

				for (var i = 0; i < filteredOcios.length; i++) {
					var option = document.createElement('option');
					option.value = filteredOcios[i].id;
					option.text = filteredOcios[i].nombre;
					selectOcio.appendChild(option);
				};
				//Mostramos el div que contiene el select del Ocio
				divOcio.style.display = "block";
				selectOcio.addEventListener('change', function () {
					if (this.value !== "0") {
						//Recogemos el objeto Decorado
						var o = buscarObjetoPorId(this.value, ocioList);
						var i = document.getElementById('fotoOcio');
						var p = document.getElementById('precioOcio');
						if (o) {
							//Recogemos el elemento con la imagen y el input 
							p.placeholder = o.precio_hora;
							i.src = o.foto;
						} else {
							p.placeholder = "Error";
							i.alt = "Error";
						}
						divFPOcio.style.display = "block";
					} else {
						divFPOcio.style.display = "none";
					}
				});
			}

		}

		function vaciarSelect(select) {
			var options = select.getElementsByTagName("option");

			for (let i = 0; i < options.length; i++) {
				if (options[i].value !== "0") {
					select.removeChild(options[i]);
				}
			}
		}

		function buscarObjetoPorId(id, lista) {
			const objetoEncontrado = lista.find(objeto => objeto.id == id);
			return objetoEncontrado ? objetoEncontrado : null;
		}
	</script>

	<script th:src="@{/vendor/bootstrap-5.2.3/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/js/jquery-3.6.3.js}"></script>
	<script th:src="@{/js/script.js}"></script>
	<!--<script th:src="@{/js/formE.js}"></script>-->
</body>

</html>